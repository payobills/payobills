name: 'ci'

on:
  pull_request:
    branches:
    - develop
    - main
  push:
    branches:
    - develop
    - main
    - 'release/**'
    - 'hotfix/**'

env:
  PROJECT_NAME: payobills

jobs:
  gitversion:
    name: gitversion
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Test
      run: ./pleasew build //...

    - name: Tag build
      if: ${{ github.event_name == 'push' && (startsWith(steps.calculate_changed_services.outputs.diff_dest, 'release') || startsWith(steps.calculate_changed_services.outputs.diff_dest, 'hotfix') || contains(env.MAIN_BRANCHES, steps.calculate_changed_services.outputs.diff_dest)) }}
      env:
        DIFF_DEST: ${{ steps.calculate_changed_services.outputs.DIFF_DEST }}
        SEMVERYEASY_CHANGED: ${{ steps.calculate_changed_services.outputs.changed }}
        SEMVERYEASY_CHANGED_SERVICES: ${{ fromJSON(steps.calculate_changed_services.outputs.changed_services) }}
      run: . ./.cicd/common/semver-yeasy.sh tag