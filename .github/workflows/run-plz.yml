name: 'Run plz Command'

on:
  push:
    branches:
      - fix/plz-run-workflow-run-with-params
  workflow_dispatch:
    inputs:
      PLZ_SUBCOMMAND:
        description: 'plz subcommand to run'
        required: true
        default: 'run'
        # default: ''
      ENV_VARS:
        description: 'JSON string of environment variables'
        required: true
        default: '{ "VERSION": "0.2.1-alpha.3", "EXTRA_ARGS": "--load", "PLATFORMS": "linux/arm64" }'
        # default: '{}'
      PLZ_ARGS:
        description: 'Arguments for plz command'
        required: true
        default: '//apps/ui:docker_buildx'
        # default: ''

jobs:
  run_plz_command:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup please.build
        uses: sagikazarmark/setup-please-action@v0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run plz command
        run: bash -c "$(echo "${PASSED_ENV_VARS}" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | xargs); plz run //apps/ui:docker_buildx"
        env:
          PROJECT_NAME: ${{ vars.PROJECT_NAME }}
          DOTNET_RUNTIME_VERSION: ${{ vars.DOTNET_RUNTIME_VERSION }}
          DOTNET_VERSION: ${{ vars.DOTNET_VERSION }}
          NODE_VERSION: ${{ vars.NODE_VERSION }}
          PASSED_ENV_VARS: '{ "VERSION": "0.2.1-alpha.3", "EXTRA_ARGS": "--load", "PLATFORMS": "linux/arm64" }'
